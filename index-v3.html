<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æµ·é£é™©æŒ‡æ•°ä»ªè¡¨ç›˜ (V4 - ç´¯ç§¯è¡°å‡æ¨¡å‹)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">å°æµ·é£é™©æŒ‡æ•°ä»ªè¡¨ç›˜ (V4)</h1>
            <p class="text-lg text-slate-400" id="last-updated">æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </header>

        <!-- é£é™©æŒ‡æ•°æ˜¾ç¤º -->
        <div class="mb-8 p-6 bg-slate-800 rounded-2xl shadow-2xl flex flex-col items-center justify-center transition-all duration-300">
            <h2 class="text-2xl font-semibold text-slate-300 mb-4">å½“å‰é£é™©æŒ‡æ•°</h2>
            <div id="risk-index-display" class="text-8xl font-bold text-green-500 transition-colors duration-300">
                0
            </div>
            <div id="risk-level-display" class="mt-4 text-2xl font-semibold text-green-500 transition-colors duration-300">
                ä½é£é™©
            </div>
            <p id="risk-summary" class="text-slate-400 mt-2">æ¿€æ´»äº† 0 / 0 ä¸ªæŒ‡æ ‡</p>
        </div>

        <!-- æ¿€æ´»çš„æŒ‡æ ‡æ¸…å• -->
        <div class="mb-8 p-6 bg-slate-800 rounded-2xl shadow-xl">
            <h3 class="text-2xl font-semibold mb-6">å½“å‰æ¿€æ´»çš„é¢„è­¦ä¿¡å·</h3>
            <div id="triggered-list" class="space-y-4">
                <!-- åˆ—è¡¨å°†ç”± JS åŠ¨æ€å¡«å…… -->
                <p class="text-slate-400" id="no-triggers">æœªæ¿€æ´»ä»»ä½•å…³é”®æŒ‡æ ‡ã€‚</p>
            </div>
        </div>

        <!-- LLM åˆ†ææ‘˜è¦ -->
        <div class="bg-slate-800 rounded-2xl shadow-xl overflow-hidden">
            <details class="p-6" open> <!-- é»˜è®¤ä¸ºå±•å¼€çŠ¶æ€ -->
                <summary class="text-2xl font-semibold cursor-pointer">æŸ¥çœ‹ä»Šæ—¥ LLM åˆ†ææ‘˜è¦ (ç‚¹å‡»å±•å¼€)</summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    
                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold mb-2 text-sky-400">ğŸ“ˆ ç»æµé‡‘è</h4>
                        <p id="r-econ" class="text-sm text-slate-300">...</p>
                    </div>
                    
                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold mb-2 text-orange-400">ğŸ›¡ï¸ å†›äº‹åå‹¤</h4>
                        <p id="r-mil" class="text-sm text-slate-300">...</p>
                    </div>

                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold mb-2 text-red-400">ğŸ—£ï¸ æ”¿æ²»èˆ†è®º</h4>
                        <p id="r-pol" class="text-sm text-slate-300">...</p>
                    </div>

                    <div class="bg-slate-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold mb-2 text-teal-400">ğŸ“ åœ¨åœ°ä½“æ„Ÿ (å¦é—¨)</h4>
                        <p id="r-local" class="text-sm text-slate-300">...</p>
                    </div>

                </div>
            </details>
        </div>

    </div>

    <script>
        // è·å–æ˜¾ç¤ºå…ƒç´ 
        const riskIndexDisplay = document.getElementById('risk-index-display');
        const riskLevelDisplay = document.getElementById('risk-level-display');
        const riskSummary = document.getElementById('risk-summary');
        const lastUpdatedDisplay = document.getElementById('last-updated');
        const triggeredList = document.getElementById('triggered-list');
        const noTriggers = document.getElementById('no-triggers');

        // è·å– LLM ç†ç”±å…ƒç´ 
        const rEcon = document.getElementById('r-econ');
        const rMil = document.getElementById('r-mil');
        const rPol = document.getElementById('r-pol');
        const rLocal = document.getElementById('r-local');

        // æ›´æ–°é£é™©é¢œè‰²
        function updateRiskColor(totalRisk) {
            const elementsToUpdate = [riskIndexDisplay, riskLevelDisplay];
            elementsToUpdate.forEach(el => {
                el.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500');
            });

            if (totalRisk < 20) {
                elementsToUpdate.forEach(el => el.classList.add('text-green-500'));
                riskLevelDisplay.textContent = 'ä½é£é™© (Low)';
            } else if (totalRisk < 50) {
                elementsToUpdate.forEach(el => el.classList.add('text-yellow-500'));
                riskLevelDisplay.textContent = 'ä¸­åº¦é£é™© (Medium)';
            } else {
                elementsToUpdate.forEach(el => el.classList.add('text-red-500'));
                riskLevelDisplay.textContent = 'é«˜åº¦é£é™© (High)';
            }
        }

        // åŠ¨æ€åˆ›å»ºæ¿€æ´»çš„æŒ‡æ ‡å¡ç‰‡
        function createIndicatorCard(id, data, masterList) {
            // ä» masterList è·å–æŒ‡æ ‡çš„æè¿°å’Œç±»åˆ«
            const masterInfo = masterList[id] || { description: "æœªçŸ¥æŒ‡æ ‡", category: "æœªçŸ¥" };
            
            const baseWeight = data.base_weight;
            const currentWeight = data.current_weight;
            const triggeredOn = data.triggered_on;
            
            // æ ¹æ®æƒé‡è®¾ç½®èƒŒæ™¯è‰²
            let bgColor = 'bg-slate-700';
            if (baseWeight >= 90) bgColor = 'bg-red-900/50';
            else if (baseWeight >= 70) bgColor = 'bg-orange-900/50';

            // è®¡ç®—è¡°å‡ç™¾åˆ†æ¯”
            const decayPercentage = (currentWeight / baseWeight) * 100;
            
            return `
                <div class="${bgColor} p-4 rounded-lg border border-slate-600">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-semibold text-slate-300">${id} - ${masterInfo.category}</span>
                        <span class="text-red-400 font-bold">
                            å½“å‰æƒé‡: ${Math.round(currentWeight)} / ${baseWeight}
                        </span>
                    </div>
                    <p class="text-slate-400 mt-2 text-sm">${masterInfo.description}</p>
                    
                    <!-- è¡°å‡æ¡ -->
                    <div class="w-full bg-slate-800 rounded-full h-2.5 mt-3">
                        <div class="bg-red-500 h-2.5 rounded-full" style="width: ${decayPercentage}%"></div>
                    </div>
                    <p class="text-xs text-slate-500 mt-1 text-right">é¦–æ¬¡è§¦å‘: ${triggeredOn}</p>
                </div>
            `;
        }

        // è‡ªåŠ¨åŠ è½½ V4 æ•°æ®
        async function loadData() {
            try {
                // 1. åŠ è½½ä¸»æ•°æ® (scores-v3.json)
                const scoreResponse = await fetch('scores-v3.json?t=' + new Date().getTime());
                if (!scoreResponse.ok) throw new Error(`HTTP error! status: ${scoreResponse.status}`);
                const data = await scoreResponse.json();

                // 2. åŠ è½½æŒ‡æ ‡å¤§å¸ˆåˆ—è¡¨ (indicators.json)ï¼Œæˆ‘ä»¬éœ€è¦å®ƒæ¥è·å–æè¿°
                const indicatorsResponse = await fetch('indicators.json?t=' + new Date().getTime());
                if (!indicatorsResponse.ok) throw new Error('Failed to load indicators.json');
                const indicatorsList = await indicatorsResponse.json();
                // å°†æ•°ç»„è½¬æ¢ä¸ºå¯¹è±¡ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾
                const masterList = indicatorsList.reduce((acc, ind) => {
                    acc[ind.id] = ind;
                    return acc;
                }, {});


                // 3. æ›´æ–°ä¸»åˆ†æ•°
                const score = data.score;
                riskIndexDisplay.textContent = score;
                riskSummary.textContent = `æ¿€æ´»äº† ${data.active_indicators_count} / ${data.total_indicators_possible} ä¸ªæŒ‡æ ‡`;
                updateRiskColor(score);

                // 4. æ›´æ–°æ—¶é—´æˆ³
                const updatedDate = new Date(data.last_updated);
                lastUpdatedDisplay.textContent = `ä¸Šæ¬¡åˆ†æäº: ${updatedDate.toLocaleString()}`;

                // 5. å¡«å…… LLM ç†ç”±
                rEcon.textContent = "ä»Šæ—¥åˆ†æ: " + data.category_reasoning.econ;
                rMil.textContent = "ä»Šæ—¥åˆ†æ: " + data.category_reasoning.mil; // <-- å·²ä¿®å¤æ­¤å¤„çš„è¯­æ³•é”™è¯¯
                rPol.textContent = "ä»Šæ—¥åˆ†æ: " + data.category_reasoning.pol;
                rLocal.textContent = "ä»Šæ—¥åˆ†æ: " + data.category_reasoning.local;

                // 6. å¡«å……æ¿€æ´»çš„æŒ‡æ ‡åˆ—è¡¨
                if (data.active_indicators_count > 0) {
                    noTriggers.style.display = 'none';
                    
                    // å°†å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
                    const activeIndicatorsArray = Object.entries(data.active_indicators)
                        .map(([id, data]) => ({ id, ...data }));
                        
                    activeIndicatorsArray.sort((a, b) => b.current_weight - a.current_weight); // æŒ‰å½“å‰æƒé‡å€’åº
                    
                    let htmlContent = '';
                    activeIndicatorsArray.forEach(data => {
                        htmlContent += createIndicatorCard(data.id, data, masterList);
                    });
                    triggeredList.innerHTML = htmlContent;
                } else {
                    noTriggers.style.display = 'block';
                    triggeredList.innerHTML = '';
                }

            } catch (error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
                lastUpdatedDisplay.textContent = "åŠ è½½è‡ªåŠ¨åˆ†ææ•°æ®å¤±è´¥ã€‚è¯·æ£€æŸ¥ GitHub Action è¿è¡ŒçŠ¶æ€ã€‚";
            }
        }

        // é¡µé¢åŠ è½½æ—¶ï¼Œè‡ªåŠ¨åŠ è½½
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
