# .github/workflows/run-analysis.yml
# è¿™æ˜¯ä¸€ä¸ª GitHub Action å·¥ä½œæµï¼Œç”¨äºè‡ªåŠ¨è¿è¡Œæˆ‘ä»¬çš„åˆ†æè„šæœ¬

name: Run Risk Analysis

# è§¦å‘æ¡ä»¶
on:
  # 1. "workflow_dispatch" å…è®¸æ‚¨åœ¨ Actions æ ‡ç­¾é¡µä¸Šæ‰‹åŠ¨ç‚¹å‡» "Run workflow"
  workflow_dispatch:
  
  # 2. "schedule" å…è®¸æ‚¨æŒ‰è®¡åˆ’è‡ªåŠ¨è¿è¡Œ
  schedule:
    # cron è¯­æ³•ï¼šåˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸ
    # '0 */6 * * *' = æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡ (åœ¨ 00:00, 06:00, 12:00, 18:00 UTC)
    # é‰´äº NewsAPI çš„å…è´¹é¢åº¦ï¼Œè¯·ä¸è¦è®¾ç½®å¾—å¤ªé¢‘ç¹ã€‚
    - cron: '0 */6 * * *'

# ä»»åŠ¡å®šä¹‰
jobs:
  build-and-analyze:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu æ“ä½œç³»ç»Ÿ
    runs-on: ubuntu-latest
    
    # --- !! å…³é”®ä¿®å¤ !! ---
    # æ˜ç¡®æˆäºˆ Action "å†™å…¥" æƒé™ï¼Œä»¥ä¾¿å®ƒå¯ä»¥æ¨é€ commit
    permissions:
      contents: write
    # ---------------------

    steps:
      # ç¬¬ 1 æ­¥ï¼šæ£€å‡º (Checkout) æ‚¨çš„ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # ç¬¬ 2 æ­¥ï¼šè®¾ç½® Python 3.10 ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # ç¬¬ 3 æ­¥ï¼šå®‰è£… Python ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      # ç¬¬ 4 æ­¥ï¼šè¿è¡Œåˆ†æè„šæœ¬
      # å®ƒä¼šè‡ªåŠ¨ä½¿ç”¨æ‚¨åœ¨ç¬¬ 1 æ­¥ä¸­è®¾ç½®çš„ "Secrets"
      - name: Run analysis script
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          python analyst-v5.py
      
      # ç¬¬ 5 æ­¥ï¼š(å…³é”®) å°†ç”Ÿæˆçš„ scores-v3.json æäº¤å›ä»“åº“
      - name: Commit and push score file
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add scores-v3.json
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“ˆ Auto-update risk analysis data"
            git push
          else
            echo "No changes to commit."
          fi


